<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title th:text="${pageTitle} ?: 'Add Booking'">Add Booking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gradient-to-br from-green-100 to-blue-100 min-h-screen text-[17px] font-sans">

  <!-- Navbar -->
  <div th:replace="fragments/navbar :: navbar"></div>

  <!-- Booking Card -->
  <div class="max-w-5xl mx-auto mt-10 bg-white/80 backdrop-blur-md border border-gray-200 shadow-2xl rounded-2xl p-10">
    <h2 class="text-4xl font-extrabold text-center text-green-700 mb-10 drop-shadow">🎫 Confirm Your Booking</h2>

    <!-- Bus Info Card -->
    <div class="bg-blue-50 border-l-4 border-blue-400 shadow-md rounded-xl p-6 mb-10 space-y-2">
      <p><strong>🚌 Bus:</strong> <span th:text="${bus.busName}">Bus Name</span></p>
      <p><strong>📍 Route:</strong> <span th:text="${bus.routeFrom}">From</span> → <span th:text="${bus.routeTo}">To</span></p>
      <p><strong>🗓️ Date:</strong> <span th:text="${bus.busJourneyDate}">Journey Date</span></p>
      <p><strong>🕒 Departure:</strong> <span th:text="${bus.departureTime}">Departure</span></p>
      <p><strong>🕒 Arrival:</strong> <span th:text="${bus.arrivalTime}">Arrival</span></p>
      <p><strong>🎟️ Fare/Seat:</strong> ₹<span th:text="${bus.fare}">Fare</span></p>
      <p><strong>🪑 Available Seats:</strong> <span id="availableSeats" th:text="${bus.seats}">Seats</span></p>
    </div>

    <!-- Booking Form -->
    <form th:action="@{/bookings/addBooking(busId=${bus.busId})}" method="post" th:object="${bookingDto}" onsubmit="return validateSeatCount()">
      <input type="hidden" name="busId" th:value="${bus.busId}" />

      <!-- Mobile Number -->
      <div class="mb-8">
        <label for="mobile" class="block text-gray-800 font-semibold mb-2">📞 Mobile Number</label>
        <input type="tel" id="mobile" th:field="*{mobileNumber}" required pattern="[0-9]{10}" maxlength="10"
               placeholder="Enter 10-digit number"
               class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 text-lg shadow-sm" />
        <p class="text-sm text-gray-500 mt-1">Must be exactly 10 digits</p>
      </div>

      <!-- Seat Count -->
      <div class="mb-8">
        <label for="bookseat" class="block text-gray-800 font-semibold mb-2">🪑 Number of Seats</label>
        <input type="number" id="bookseat" th:field="*{bookseat}" min="1"
               oninput="generatePassengerFields(this.value)" required
               class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 text-lg shadow-sm" />
        <p id="seatError" class="text-red-600 mt-1 hidden">❌ Requested seats exceed available.</p>
      </div>

      <!-- Passenger Fields -->
      <div id="passengerDetailsContainer" class="space-y-6 mb-10"></div>

      <!-- Submit Button -->
      <div class="text-center">
        <button type="submit"
                class="bg-green-600 hover:bg-green-700 text-white text-lg px-10 py-4 rounded-xl shadow-lg transition-transform transform hover:scale-105">
          ✅ Confirm Booking & Proceed to Payment
        </button>
      </div>
    </form>
  </div>

  <!-- JS -->
  <script>
    function generatePassengerFields(seatCount) {
      const available = parseInt(document.getElementById("availableSeats").innerText);
      const error = document.getElementById("seatError");
      const container = document.getElementById("passengerDetailsContainer");

      if (seatCount > available) {
        error.classList.remove("hidden");
        container.innerHTML = "";
        return;
      } else {
        error.classList.add("hidden");
      }

      container.innerHTML = '';
      for (let i = 1; i <= seatCount; i++) {
        const group = document.createElement('div');
        group.className = "grid grid-cols-1 md:grid-cols-2 gap-4 bg-white/90 p-5 rounded-xl shadow-md";

        group.innerHTML = `
          <div>
            <label class="block text-gray-800 font-semibold mb-1">👤 Passenger ${i} Name</label>
            <input type="text" name="passengerNames" required
                   placeholder="Enter name"
                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
          </div>
          <div>
            <label class="block text-gray-800 font-semibold mb-1">🎂 Passenger ${i} Age</label>
            <input type="number" name="passengerAges" required min="18" max="100"
                   placeholder="Age (18–100)"
                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
          </div>
        `;
        container.appendChild(group);
      }
    }

    function validateSeatCount() {
      const seatInput = document.getElementById("bookseat");
      const available = parseInt(document.getElementById("availableSeats").innerText);
      const requested = parseInt(seatInput.value);
      const error = document.getElementById("seatError");

      if (requested > available || requested <= 0) {
        error.classList.remove("hidden");
        return false;
      }
      return true;
    }
  </script>

</body>
</html>
